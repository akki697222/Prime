-- PrimeOS Minimal Shell
-- File: /usr/bin/sh

---@type stdin
local stdin = require("io.stdin")
---@type stdout
local stdout = require("io.stdout")
---@type stderr
local stderr = require("io.stderr")
---@type user
local user = require("system.user")
---@type filesystem
local fs = require("system.filesystem")
---@type printUtils
local printutils = require("system.util.print")
---@type process
local process = require("system.process")

local running = true

local s, e = pcall(function()
    while running do
        stdout:write(user.getData(user.getCurrent()).name .. "@primeos# ")
        local input = stdin:read()
        if input == "exit" then
            running = false
        elseif input and input ~= "" then
            local args = {}
            for word in input:gmatch("%S+") do
                table.insert(args, word)
            end
            local cmd = table.remove(args, 1)
            local path = fs.combine(fs.cwd(), cmd)
            if not fs.exists(path) then
                path = fs.combine("/usr/bin", cmd)
            end
            if fs.exists(path) then
                process.fork(path, args)
                coroutine.yield()
            else
                printf("&cCommand not found: " .. cmd .. "&0")
            end
        end
    end
end)

if not s then
    printk(e)
    while true do
        coroutine.yield()
    end
end